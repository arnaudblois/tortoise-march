"""Test that the ops of the Schema Editor can be executed correctly."""

import os
import pytest
import asyncpg

from tortoisemarch.operations import (
    CreateModel,
    AddField,
    RemoveField,
    AlterField,
    RemoveModel,
)
from tortoisemarch.schema_editor import PostgresSchemaEditor

DATABASE_URL = os.environ.get(
    "DATABASE_URL", "postgres://postgres:postgres@localhost:5432/testdb"
)


@pytest.mark.asyncio
async def test_create_and_remove_model():
    """Test CreateModel and RemoveModel ops work correctly."""
    conn = await asyncpg.connect(DATABASE_URL)
    schema_editor = PostgresSchemaEditor()

    # Clean slate
    await conn.execute('DROP TABLE IF EXISTS "book" CASCADE')

    # Create Book model with id + title
    op = CreateModel(
        name="Book",
        db_table="book",
        fields=[
            ("id", "IntField", {"primary_key": True}),
            ("title", "CharField", {"null": False, "max_length": 200}),
        ],
    )
    await op.apply(conn, schema_editor)

    # Verify table exists
    result = await conn.fetchval(
        "SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name='book')"
    )
    assert result is True

    # Drop the table
    op = RemoveModel(name="Book")
    await op.apply(conn, schema_editor)

    # Verify table removed
    result = await conn.fetchval(
        "SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name='book')"
    )
    assert result is False

    await conn.close()


@pytest.mark.asyncio
async def test_add_and_remove_field():
    """Test that AddField and RemoveField ops are executed correctly."""
    conn = await asyncpg.connect(DATABASE_URL)
    schema_editor = PostgresSchemaEditor()

    # Clean slate
    await conn.execute('DROP TABLE IF EXISTS "author" CASCADE')
    await conn.execute('CREATE TABLE "author" (id SERIAL PRIMARY KEY)')

    # Add "name" field
    op = AddField(
        model_name="Author",
        field_name="name",
        field_type="CharField",
        options={"null": False, "max_length": 100},
    )
    await op.apply(conn, schema_editor)

    # Verify column exists
    result = await conn.fetchval(
        "SELECT EXISTS (SELECT 1 FROM information_schema.columns "
        "WHERE table_name='author' AND column_name='name')"
    )
    assert result is True

    # Remove "name" field
    op = RemoveField(model_name="Author", field_name="name")
    await op.apply(conn, schema_editor)

    result = await conn.fetchval(
        "SELECT EXISTS (SELECT 1 FROM information_schema.columns "
        "WHERE table_name='author' AND column_name='name')"
    )
    assert result is False

    await conn.close()


@pytest.mark.asyncio
async def test_alter_field_nullability_and_default():
    """Test that AlterField's null amd default are honoured."""
    conn = await asyncpg.connect(DATABASE_URL)
    schema_editor = PostgresSchemaEditor()

    # Clean slate
    await conn.execute('DROP TABLE IF EXISTS "user_account" CASCADE')
    await conn.execute(
        'CREATE TABLE "user_account" (id SERIAL PRIMARY KEY, email VARCHAR(200))'
    )

    # Alter "email" field: set NOT NULL and add DEFAULT
    op = AlterField(
        model_name="UserAccount",
        field_name="email",
        old_options={"null": True, "default": None, "field_type": "CharField"},
        new_options={
            "null": False,
            "default": "unknown@example.com",
            "field_type": "CharField",
        },
    )
    await op.apply(conn, schema_editor)

    # Verify NOT NULL
    is_nullable = await conn.fetchval(
        "SELECT is_nullable FROM information_schema.columns "
        "WHERE table_name='user_account' AND column_name='email'"
    )
    assert is_nullable == "NO"

    # Verify default
    column_default = await conn.fetchval(
        "SELECT column_default FROM information_schema.columns "
        "WHERE table_name='user_account' AND column_name='email'"
    )
    assert "unknown@example.com" in (column_default or "")

    await conn.close()
